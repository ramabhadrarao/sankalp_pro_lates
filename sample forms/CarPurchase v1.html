<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan Your New Car</title>
  <style>
    /* Preserved app styles — do not change unless requested */
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;padding:28px;margin:0}
    .form-wrap{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1{color:#0b4da0;margin:0 0 8px;text-align:center}
    h2{color:#d41031;margin:0 0 4px;text-align:center}
    p.lead{color:#374151;margin:10px 0 16px;text-align:center}
    label{display:block;margin:8px 0 6px;font-weight:700;color:#111}
    label .req{color:#c00;margin-left:6px}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #d1d5db;box-sizing:border-box;font-size:14px}
    input[readonly]{background:#f3f4f6}
    .two-col{display:flex;gap:12px}
    .two-col > div{flex:1}
    .btn{background:#0b5fff;color:#fff;padding:10px 14px;border-radius:6px;border:none;cursor:pointer}
    .btn[disabled]{opacity:.7;cursor:default}
    .small{font-size:13px;color:#374151}
    .hidden{display:none}
    .disabled{background:#f3f4f6;color:#6b7280}
    @media (max-width:720px){ .two-col{flex-direction:column} }
    .why-matters { font-weight: bold; color: #057722; font-size: .8em; margin-top: 4px; }

    /* modal + other styles preserved */
    .self-fund-badge { display:none; margin-top:10px; padding:6px 10px; background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; border-radius:8px; font-weight:700; text-align:left; }
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center}
    .modal{background:#fff;padding:22px;border-radius:10px;max-width:820px;width:96%;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .comparison-table{width:100%;border-collapse:collapse;margin-top:6px}
    .comparison-table th,.comparison-table td{border:1px solid #e6eef9;padding:10px;text-align:center}
    .caption-small{font-size:12px;color:#6b7280;margin-top:6px}
    .income-row{display:flex;gap:8px;align-items:center}
    .income-row input[type="checkbox"]{width:auto;margin-right:8px}
    .income-amount{width:48%}
    .income-amount input{width:100%}
    .income-breakdown{font-size:13px;color:#374151;margin-top:8px}
    .required-large{font-weight:900;font-size:1.2rem;color:#0b5fff;margin-top:6px;text-align:center}
    .shortfall-large{color:#ff2b2b;font-weight:900;font-size:1.1rem;margin-top:6px;text-align:center}
    .comparison-title{ text-align:center; font-weight:800; font-size:1.05rem; text-decoration:underline; margin-top:16px; margin-bottom:6px; text-transform:uppercase; }
    .modalPitch{font-size:1.02rem;color:#333;margin-top:12px;text-align:center;line-height:1.35}
    .cta-row{display:flex;gap:12px;margin-top:18px;justify-content:flex-end}
    .cta-row a{flex:1;padding:12px 14px;border-radius:8px;text-decoration:none;color:#fff;text-align:center;display:inline-block}
    .primary-cta{background:#007bff}
    .secondary-cta{background:#0b5fff;opacity:.95}
    .status-msg{font-size:13px;margin-top:8px;color:#333}
    .highlight-red {color: red; font-weight: bold;}
    
    
 
  </style>
</head>
<body>
  <div class="form-wrap" role="main" aria-labelledby="title">
    <h1 id="title">Plan Your New Car</h1>
    <h2>GET THE KEYS, NOT THE FINANCIAL STRESS</h2>
    <p class="lead">Enter your car cost, savings, and timeline — we’ll crunch the numbers and guide you with loan estimates, EMI checks, and a savings plan that keeps things comfortable.</p>

    <form id="carForm" novalidate>
      <input type="hidden" id="timestamp" name="timestamp" value="">

      <!-- Personal / identity -->
      <label for="fullName">Full Name <span class="req">*</span></label>
      <input id="fullName" name="fullName" type="text" placeholder="e.g., Kapil Sharma" required>

      <div class="two-col">
        <div>
          <label for="dob">Date of Birth <span class="req">*</span></label>
          <input id="dob" name="dob" type="date" required>
          <div class="caption-small">Minimum age: 23 years (form enforces this).</div>
        </div>
        <div>
          <label for="age">Age <span class="req">*</span></label>
          <input id="age" name="age" type="text" readonly placeholder="Calculated from DOB" required>
        </div>
      </div>

      <div class="two-col">
        <div>
          <label for="city">City of Residence <span class="req">*</span></label>
          <select id="city" name="city" required></select>
          <input id="otherCity" name="otherCity" type="text" placeholder="Enter your city" style="margin-top:8px;display:none">
        </div>
        <div>
          <label style="visibility:hidden">placeholder</label>
          <input style="visibility:hidden">
        </div>
      </div>

      <!-- Car & Finance Details -->
      <div style="margin-top:14px">
        <h3>Car & Finance Details</h3>

        <div class="two-col">
          <div>
            <label for="carType">Car Type <span class="req">*</span></label>
            <select id="carType" name="carType" required>
              <option value="">Select</option>
              <option>Hatchback</option>
              <option>Sedan</option>
              <option>SUV</option>
              <option>Luxury</option>
              <option>Electric Vehicle (EV)</option>
            </select>
          </div>
          <div>
            <label for="purchaseYears">Purchase Timeline (Years) <span class="req">*</span></label>
            <select id="purchaseYears" name="purchaseYears" required>
              <option value="">Select years</option>
              <option value="1">1 year</option>
              <option value="2">2 years</option>
              <option value="3">3 years</option>
              <option value="4">4 years</option>
              <option value="5">5 years</option>
              <option value="6">6 years</option>
              <option value="7">7 years</option>
              <option value="8">8 years</option>
              <option value="9">9 years</option>
              <option value="10">10 years</option>
            </select>
          </div>
        </div>

        <div class="two-col" style="margin-top:10px">
          <div>
            <label for="estimatedCost">Target Car Estimated Cost (₹) <span class="req">*</span></label>
            <input id="estimatedCost" name="estimatedCost" type="text" placeholder="₹ e.g., 12,00,000" required>
            <div class="why-matters">This anchors loan amount and EMI calculations.</div>
          </div>
          <div>
            <label for="expectedDownPayment">Expected Down Payment at Purchase (₹) <span class="req">*</span></label>
            <input id="expectedDownPayment" name="expectedDownPayment" type="text" placeholder="₹ e.g., 2,00,000" required>
            <div class="caption-small">Enter the amount you plan to bring at purchase time.</div>
          </div>
        </div>

        <div class="two-col" style="margin-top:10px">
          <div>
            <label for="existingDownSavings">Existing Savings for Down Payment</label>
            <input id="existingDownSavings" name="existingDownSavings" type="text" placeholder="₹">
            <div class="nudge" style="margin-top:6px">If your savings fully cover expected DP, the loan numbers will be auto-handled in the summary modal.</div>
          </div>
          <div>
            <label for="otherCommitments">Existing Monthly Commitments (EMIs etc.)</label>
            <input id="otherCommitments" name="otherCommitments" type="text" placeholder="₹">
            <div class="caption-small">List ongoing EMIs or fixed monthly obligations.</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h3>Income Sources (enter monthly amounts)</h3>

          <div class="two-col" style="align-items:center">
            <div>
              <div class="income-row">
                <input type="checkbox" id="salariedChk" class="incomeChk" data-weight="1">
                <label for="salariedChk" style="margin:0;font-weight:700">Salaried</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="salariedIncome" type="text" placeholder="Monthly salaried income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="businessChk" class="incomeChk" data-weight="0.8">
                <label for="businessChk" style="margin:0;font-weight:700">Business</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="businessIncome" type="text" placeholder="Monthly business income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="two-col" style="align-items:center;margin-top:8px">
            <div>
              <div class="income-row">
                <input type="checkbox" id="selfEmpChk" class="incomeChk" data-weight="0.8">
                <label for="selfEmpChk" style="margin:0;font-weight:700">Self-employed / Professional</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="selfEmpIncome" type="text" placeholder="Monthly professional income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="rentalChk" class="incomeChk" data-weight="0.7">
                <label for="rentalChk" style="margin:0;font-weight:700">Rental</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="rentalIncome" type="text" placeholder="Monthly rental income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="two-col" style="align-items:center;margin-top:8px">
            <div>
              <div class="income-row">
                <input type="checkbox" id="agriChk" class="incomeChk" data-weight="0.5">
                <label for="agriChk" style="margin:0;font-weight:700">Agricultural</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="agriIncome" type="text" placeholder="Monthly agricultural income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="otherChk" class="incomeChk" data-weight="0.5">
                <label for="otherChk" style="margin:0;font-weight:700">Other</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="otherIncome" type="text" placeholder="Other monthly income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="income-breakdown" style="margin-top:10px">
            <label for="weightedMonthlyInput" style="margin:0;font-weight:700">Weighted Monthly Income</label>
            <input id="weightedMonthlyInput" type="text" readonly value="₹0" style="background:#f3f4f6;margin-top:6px;font-weight:700">
            <div class="caption-small" style="margin-top:6px">Weights applied: Salaried 100%, Business 80%, Self-employed 80%, Rental 70%, Agricultural 50%, Other 50% (indicative).</div>
          </div>
        </div>

        <div class="two-col" style="margin-top:12px">
          <div>
            <label for="loanTenureYears">Preferred Loan Tenure (Years) <span class="req">*</span></label>
            <input id="loanTenureYears" name="loanTenureYears" type="text" min="1" max="10" placeholder="e.g., 5" required>
          </div>
          <div>
            <label for="interestRate">Expected Auto Loan Interest Rate (%) <span class="req">*</span></label>
            <input id="interestRate" name="interestRate" type="text" min="1" max="20" placeholder="e.g., 9.5" required>
          </div>
        </div>

        <div style="margin-top:12px" class="note-muted">
          <strong>Note:</strong> Loan eligibility calculation uses your weighted monthly income and the simple rule: <em>eligibility = weighted monthly income × 24</em>.
        </div>

        <div class="two-col" style="margin-top:12px">
          <div>
            <label for="monthlyAffordability">Monthly EMI Affordability (₹) <span class="req">*</span></label>
            <input id="monthlyAffordability" name="monthlyAffordability" type="text" placeholder="₹ you can comfortably pay" required>
            <div class="caption-small">We will also compute a benchmark from your income (used for EMI fit).</div>
          </div>
          <div>
            <label for="expectedReturn">Expected Rate of Return on Investments (%)</label>
            <input id="expectedReturn" name="expectedReturn" type="number" min="0" max="25" step="0.1" placeholder="e.g., 7.5">
            <div class="caption-small">Used only to estimate monthly saving needed to build DP shortfall.</div>
          </div>
        </div>

      </div>

      <!-- Consent -->
      <div style="margin-top:12px">
        <input id="consent" name="consent" type="checkbox" required>
        <label for="consent">I consent to my information being used to generate a personalised car purchase recommendation and to be contacted by the advisor. <span style="color:#c00">*</span></label>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button class="btn" id="computeBtn" type="button">Compute Quick Recommendation</button>
        <span id="statusMsg" class="small" aria-live="polite"></span>
      </div>

      <textarea id="detailedData" style="display:none" aria-hidden="true"></textarea>
    </form>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="quickModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Quick Recommendation</h2>

      <div id="modalHeadline" class="required-large">—</div>

      <div id="modalShortfallWrap" style="display:none">
        <div class="shortfall-large" id="modalShortfall">—</div>
      </div>

      <h3 class="comparison-title">MINI COMPARISON</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Loan Requirement (₹)</th>
            <th>Loan Eligibility (₹)</th>
            <th>Estimated EMI (₹)</th>
            <th>EMI Affordability (₹)</th>
          </tr>
        </thead>
        <tbody>
          <tr id="modalComparisonRow">
            <td id="cellRequirement">—</td>
            <td id="cellEligibility">—</td>
            <td id="cellEMI">—</td>
            <td id="cellAffordability">—</td>
          </tr>
        </tbody>
      </table>

      <h3 class="comparison-title" style="margin-top:14px">DOWN PAYMENT PLAN</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Expected DP (₹)</th>
            <th>Existing Savings (₹)</th>
            <th>Additional DP to Accumulate (₹)</th>
            <th>Years to Accumulate</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="cellExpectedDP">—</td>
            <td id="cellExistingDP">—</td>
            <td id="cellDPShortfall">—</td>
            <td id="cellYears">—</td>
          </tr>
        </tbody>
      </table>

      <div style="margin-top:10px;text-align:center">
        <div id="cellMonthlySIP" class="required-large">—</div>
        <div class="caption-small" id="cellSIPNotes"> </div>
      </div>

      <div id="modalIncomeBreakdown" class="caption-small" style="margin-top:12px; text-align:left"></div>

      <div id="modalPitch" class="modalPitch"></div>

      <div class="cta-row" style="margin-top:12px">
        <a id="bookCall" class="primary-cta" href="#" target="_blank">Request a Call</a>
        <a id="requestReport" class="secondary-cta" href="/request-report" target="_blank">Request Detailed Report</a>
      </div>
      <div id="modalStatus" class="status-msg"></div>
    </div>
  </div>

<script>
/* ---------- Utilities (preserved) ---------- */
function parseNum(v){
  if (v === undefined || v === null) return 0;
  const s = (''+v).replace(/,/g,'').replace(/₹/g,'').replace(/N\/A/g,'').trim();
  if (s === '') return 0;
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtINR(n){
  if (!isFinite(n)) return '—';
  return '₹' + Math.round(n).toLocaleString('en-IN');
}
function attachCurrencyMask(el){
  if (!el) return;
  el.addEventListener('input', function () {
    if (el.disabled) return;
    const raw = el.value || '';
    const digits = raw.replace(/\D/g, '');
    if (digits === '') { el.value = ''; return; }
    const limited = digits.slice(0, 14);
    const formatted = new Intl.NumberFormat('en-IN').format(Number(limited));
    el.value = '₹' + formatted;
  });
  el.addEventListener('blur', function () {
    if (el.disabled) return;
    const digits = (el.value || '').replace(/\D/g, '');
    el.value = digits === '' ? '' : '₹' + new Intl.NumberFormat('en-IN').format(Number(digits));
  });
  el.addEventListener('focus', function () {
    if (el.disabled) return;
    const digits = (el.value || '').replace(/\D/g, '');
    el.value = digits ? digits : '';
  });
}

/* EMI & savings math (preserved) */
function emi(p, annualRatePct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualRatePct/12)/100;
  if (p <= 0 || n <= 0) return 0;
  if (r <= 0) return p / n;
  const pow = Math.pow(1+r, n);
  return p * r * pow / (pow - 1);
}
function loanFromEmi(emiAmt, annualRatePct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualRatePct/12)/100;
  if (emiAmt <= 0 || n <= 0) return 0;
  if (r <= 0) return emiAmt * n;
  const pow = Math.pow(1+r, n);
  return emiAmt * (pow - 1) / (r * pow);
}
function monthlyInvestmentForFV(fv, annualReturnPct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualReturnPct/12)/100;
  if (fv <= 0) return 0;
  if (r <= 0) return fv / n;
  const pow = Math.pow(1+r, n);
  return fv * r / (pow - 1);
}

/* ---------- DOM wiring + protections (preserved + requested tweaks) ---------- */
document.addEventListener('DOMContentLoaded', function(){
  try {
    document.getElementById('timestamp').value = new Date().toLocaleString();

    // DOB max to enforce min age = 23
    const dobEl = document.getElementById('dob');
    (function setDobMax(){
      const now = new Date();
      const y = now.getFullYear() - 23;
      const m = String(now.getMonth() + 1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      if (dobEl) dobEl.max = `${y}-${m}-${d}`;
    })();

    // DOB -> age calc (min age 23 enforced)
    const ageField = document.getElementById('age');
    if (dobEl) {
      dobEl.addEventListener('change', function(){
        const v = this.value;
        if (!v){ ageField.value = ''; return; }
        const d = new Date(v + 'T00:00:00');
        if (isNaN(d)){ ageField.value=''; return; }
        const now = new Date();
        let age = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
        age = Math.max(0, age);
        if (age < 23){
          alert('Minimum age must be 23 years.');
          this.value = '';
          ageField.value = '';
          return;
        }
        ageField.value = age;
      });
    }

    // Cities: top 30 alphabetical + Others at end
    const citySelect = document.getElementById('city');
    const cities = [
      "Ahmedabad","Amritsar","Bengaluru","Bhopal","Bhubaneswar","Chandigarh","Chennai","Coimbatore","Dehradun",
      "Delhi","Faridabad","Ghaziabad","Gurugram","Guwahati","Hyderabad","Indore","Jaipur","Jalandhar","Kanpur",
      "Kochi","Kolkata","Lucknow","Madurai","Mumbai","Nagpur","Nashik","Patna","Pune","Surat","Vadodara"
    ];
    function fillCity(select){
      if (!select) return;
      select.innerHTML = '<option value="">Select City</option>';
      cities.forEach(c => { const o=document.createElement('option'); o.value=c; o.text=c; select.appendChild(o); });
      const o = document.createElement('option'); o.value='Others'; o.text='Others'; select.appendChild(o);
    }
    fillCity(citySelect);

    // show/hide otherCity input when 'Others' selected
    if (citySelect) citySelect.addEventListener('change', function(){
      if (this.value === 'Others') { document.getElementById('otherCity').style.display = 'block'; }
      else { document.getElementById('otherCity').style.display = 'none'; }
    });

    // Currency masks: include income & other inputs
    [
      'estimatedCost','expectedDownPayment','existingDownSavings','otherCommitments',
      'monthlyAffordability','salariedIncome','businessIncome','selfEmpIncome','agriIncome','rentalIncome','otherIncome'
    ].forEach(id => { const el=document.getElementById(id); if (el) attachCurrencyMask(el); });

    // Update loan requirement whenever estimatedCost or expectedDownPayment changes (preserved pattern)
    const costEl = document.getElementById('estimatedCost');
    const expectedDP = document.getElementById('expectedDownPayment');
    const existingDP = document.getElementById('existingDownSavings');

    function updateLoanRequirement(){ /* no auto loanRequirement field in car form; kept for parity */ }

    // Income sources wiring (auto-calc Weighted Monthly Income)
    const incomeCheckboxes = document.querySelectorAll('.incomeChk');
    incomeCheckboxes.forEach(chk => {
      chk.addEventListener('change', function(){
        const id = this.id.replace('Chk','Income');
        const input = document.getElementById(id);
        if (!input) return;
        input.disabled = !this.checked;
        if (!this.checked) input.value = '';
        updateWeightedMonthly();
      });
    });
    ['salariedIncome','businessIncome','selfEmpIncome','agriIncome','rentalIncome','otherIncome'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateWeightedMonthly);
    });

    function updateWeightedMonthly(){
      const mapping = [
        {chk:'salariedChk', id:'salariedIncome', w:1},
        {chk:'businessChk', id:'businessIncome', w:0.8},
        {chk:'selfEmpChk', id:'selfEmpIncome', w:0.8},
        {chk:'agriChk', id:'agriIncome', w:0.5},
        {chk:'rentalChk', id:'rentalIncome', w:0.7},
        {chk:'otherChk', id:'otherIncome', w:0.5}
      ];
      let total = 0;
      mapping.forEach(m => {
        const chk = document.getElementById(m.chk);
        const el = document.getElementById(m.id);
        const val = el ? parseNum(el.value) : 0;
        if (chk && chk.checked && val>0) total += val * m.w;
      });
      const weightedInput = document.getElementById('weightedMonthlyInput');
      if (weightedInput){
        weightedInput.value = total ? fmtINR(total) : '₹0';
      }
    }

    // Ensure initial state run
    setTimeout(updateWeightedMonthly, 120);

  } catch (e) {
    console.warn('Initialization warning (non-fatal):', e);
  }
    function formatEligibility(eligibility, loanRequirement) {
      if (eligibility < loanRequirement) {
        return '<span class="highlight-red">₹' + eligibility.toLocaleString() + '</span>';
      }
      return '₹' + eligibility.toLocaleString();
    }

    function formatEMI(emi, affordability) {
      if (emi > affordability) {
        return '<span class="highlight-red">₹' + emi.toLocaleString() + '</span>';
      }
      return '₹' + emi.toLocaleString();
    }

    function formatAffordability(emi, affordability) {
      if (emi > affordability) {
        return '<span class="highlight-red">₹' + affordability.toLocaleString() + '</span>';
      }
      return '₹' + affordability.toLocaleString();
    }

});

/* ---------- Compute & Modal (eligibility = weightedMonthly * 24) ---------- */
document.getElementById('computeBtn').addEventListener('click', async function(){
  try {
    const consent = document.getElementById('consent');
    if (!consent || !consent.checked){ alert('Please provide consent to proceed.'); consent && consent.focus(); return; }

    // basic validations
    const fullName = (document.getElementById('fullName').value || '').trim();
    if (!fullName){ alert('Please enter your full name'); return; }
    let age = parseInt(document.getElementById('age').value || '0', 10);
    if (!age || age < 23){ alert('You must be at least 23 years old to proceed.'); return; }

    // compute weighted monthly income
    const mapping = [
      {chk:'salariedChk', id:'salariedIncome', w:1, label:'Salaried'},
      {chk:'businessChk', id:'businessIncome', w:0.8, label:'Business'},
      {chk:'selfEmpChk', id:'selfEmpIncome', w:0.8, label:'Self-employed'},
      {chk:'agriChk', id:'agriIncome', w:0.5, label:'Agricultural'},
      {chk:'rentalChk', id:'rentalIncome', w:0.7, label:'Rental'},
      {chk:'otherChk', id:'otherIncome', w:0.5, label:'Other'}
    ];
    let totalWeightedMonthly = 0;
    const breakdownItems = [];
    mapping.forEach(m => {
      const chk = document.getElementById(m.chk);
      const val = parseNum(document.getElementById(m.id).value);
      if (chk && chk.checked){
        const weighted = Math.round(val * m.w);
        totalWeightedMonthly += weighted;
        breakdownItems.push({label:m.label, raw:val, weight:m.w, weighted:weighted});
      }
    });

    if (totalWeightedMonthly <= 0){
      alert('Please enter at least one income source amount (monthly).');
      return;
    }

    const annualWeightedIncome = totalWeightedMonthly * 12;

    // inputs
    const cost = parseNum(document.getElementById('estimatedCost').value);
    const expectedDP = parseNum(document.getElementById('expectedDownPayment').value);
    if (cost <= 0){ alert('Please enter a valid Target Car Estimated Cost.'); return; }
    if (expectedDP < 0){ alert('Please enter the Expected Down Payment at purchase.'); return; }
    if (expectedDP > cost){ alert('Expected Down Payment cannot exceed Car Cost.'); return; }

    const existingSavings = parseNum(document.getElementById('existingDownSavings').value);
    if (existingSavings < 0){ alert('Existing Down Payment Savings cannot be negative.'); return; }

    const purchaseYears = parseInt(document.getElementById('purchaseYears').value || '0', 10);
    if (!purchaseYears || purchaseYears < 1 || purchaseYears > 15){ alert('Select Purchase Timeline between 1 and 15 years.'); return; }

    const expectedReturn = parseFloat(document.getElementById('expectedReturn').value || '0');
    if (!isFinite(expectedReturn) || expectedReturn < 0 || expectedReturn > 25){ /* allow 0 as default */ }

    // Determine self-funded case
    const selfFunded = (expectedDP === cost && cost > 0);

    // Loan related
    const loanReq = selfFunded ? 0 : Math.max(0, cost - expectedDP);
    const otherCommit = parseNum(document.getElementById('otherCommitments').value);
    const declaredAfford = parseNum(document.getElementById('monthlyAffordability').value);

    let estEmi = 0, eligibleLoanFromAfford = 0, eligibleLoanFromMultiplier = 0, finalEligibility = 0, effectiveAfford = 0, emiShortfall = 0, loanGap = 0;
    let appliedTenure = parseFloat(document.getElementById('loanTenureYears') ? document.getElementById('loanTenureYears').value || '0' : '0');
    const rate = parseFloat(document.getElementById('interestRate').value || '0');

    if (!selfFunded) {
      if (!isFinite(appliedTenure) || appliedTenure < 1 || appliedTenure > 40){ alert('Loan tenure must be between 1 and 40 years.'); return; }
      if (!isFinite(rate) || rate < 1 || rate > 20){ alert('Interest rate must be between 1% and 20%.'); return; }

      // FOIR benchmark for autos (kept conservative at 40%)
      const monthlyIncome = totalWeightedMonthly;
      const FOIR = 0.40;
      const benchAfford = Math.max(0, (monthlyIncome * FOIR) - otherCommit);

      // Use the lesser of declared affordability and benchAfford when declared provided
      if (declaredAfford > 0) effectiveAfford = Math.min(declaredAfford, benchAfford);
      else effectiveAfford = benchAfford;
      effectiveAfford = Math.round(effectiveAfford);

      // compute EMI
      estEmi = Math.round(emi(loanReq, rate, appliedTenure));

      // Eligible loan from affordability (reverse EMI)
      eligibleLoanFromAfford = Math.round(loanFromEmi(effectiveAfford, rate, appliedTenure));

      // NEW RULE (user requested): Eligibility = Weighted Monthly × 24
      eligibleLoanFromMultiplier = Math.round(totalWeightedMonthly * 24);
      finalEligibility = eligibleLoanFromMultiplier;

      emiShortfall = Math.max(0, estEmi - effectiveAfford);
      loanGap = Math.max(0, loanReq - finalEligibility);
    }

    const dpShortfall = Math.max(0, expectedDP - existingSavings);
    let monthlySIP = 0;
    if (dpShortfall > 0){
      monthlySIP = Math.ceil(monthlyInvestmentForFV(dpShortfall, expectedReturn, purchaseYears));
    } else {
      monthlySIP = 0;
    }

    // Payload
    const residenceCity = (document.getElementById('city').value === 'Others') ? (document.getElementById('otherCity').value || 'Others') : document.getElementById('city').value;

    const detailed = {
      timestamp: document.getElementById('timestamp').value,
      identity: {
        fullName: document.getElementById('fullName').value,
        dob: document.getElementById('dob').value,
        age: parseInt(document.getElementById('age').value || '0',10),
        residenceCity: residenceCity
      },
      property: {
        carType: document.getElementById('carType').value || '',
        purchaseYears: purchaseYears
      },
      numbers: {
        estimatedCost: cost,
        expectedDownPayment: expectedDP,
        existingDownSavings: existingSavings,
        additionalDPToAccumulate: dpShortfall,
        expectedReturnPct: expectedReturn,
        loanRequirement: loanReq,
        tenureYearsRequested: parseFloat(document.getElementById('loanTenureYears').value || '0'),
        tenureYearsApplied: appliedTenure,
        interestRatePct: rate,
        monthlyAffordDeclared: declaredAfford,
        monthlyAffordBenchmark: Math.round(effectiveAfford || 0),
        otherCommitments: otherCommit,
        annualWeightedIncome: annualWeightedIncome,
        monthlyWeightedIncome: totalWeightedMonthly,
        selfFunded: selfFunded
      },
      incomeBreakdown: breakdownItems,
      computations: {
        estimatedEMI: estEmi,
        eligibleLoanAfford: eligibleLoanFromAfford,
        eligibleLoanMultiplier: eligibleLoanFromMultiplier,
        eligibleLoanFinal: finalEligibility,
        effectiveAfford: effectiveAfford === null ? null : Math.round(effectiveAfford),
        emiShortfall: emiShortfall,
        loanGap: loanGap,
        monthlySIPForDP: monthlySIP
      }
    };
    document.getElementById('detailedData').value = JSON.stringify(detailed);

    // Populate modal (exact format preserved)
    const modal = document.getElementById('quickModal');
    const headline = ( (!selfFunded && loanGap <= 0 && emiShortfall <= 0 && dpShortfall <= 0) || (selfFunded && dpShortfall <= 0) )
      ? `All set — loan (if any), EMI and down payment covered. Nice work!`
      : `Plan summary & advisor suggestions.`;
    document.getElementById('modalHeadline').textContent = headline;

    document.getElementById('cellRequirement').textContent = selfFunded ? 'N/A' : fmtINR(loanReq);
    document.getElementById('cellEligibility').textContent = selfFunded ? 'N/A' : fmtINR(finalEligibility);
    document.getElementById('cellEMI').textContent = selfFunded ? 'N/A' : fmtINR(estEmi);
    document.getElementById('cellAffordability').textContent = selfFunded ? 'N/A' : fmtINR(Math.round(effectiveAfford || 0));

    document.getElementById('cellExpectedDP').textContent = fmtINR(expectedDP);
    document.getElementById('cellExistingDP').textContent = fmtINR(existingSavings);
    document.getElementById('cellDPShortfall').textContent = fmtINR(dpShortfall);
    document.getElementById('cellYears').textContent = purchaseYears + ' yr' + (purchaseYears>1 ? 's' : '');

    if (dpShortfall <= 0){
      document.getElementById('cellMonthlySIP').textContent = 'No monthly investment needed';
      document.getElementById('cellSIPNotes').textContent = `Period: ${purchaseYears} year(s) | Expected return: ${expectedReturn}% p.a.`;
    } else {
      document.getElementById('cellMonthlySIP').textContent = fmtINR(monthlySIP) + ' / month';
      document.getElementById('cellSIPNotes').textContent = `Period: ${purchaseYears} year(s) | Expected return: ${expectedReturn}% p.a.`;
    }

    const breakdownHtml = breakdownItems.length ? (
      '<strong>Income (monthly) — weighted breakdown:</strong><ul style="text-align:left;margin-left:18px;margin-top:6px;">' +
      breakdownItems.map(it => `<li>${it.label}: ${fmtINR(it.raw)} × ${Math.round(it.weight*100)}% = ${fmtINR(it.weighted)}</li>`).join('') +
      `</ul><div style="margin-top:6px;"><strong>Total Weighted Monthly Income:</strong> ${fmtINR(totalWeightedMonthly)} (${fmtINR(annualWeightedIncome)}/yr)</div>`
    ) : '<div class="caption-small">No income breakdown provided.</div>';
    document.getElementById('modalIncomeBreakdown').innerHTML = breakdownHtml;

    const anyShortfall = (!selfFunded && ((loanGap > 0) || (emiShortfall > 0))) || (dpShortfall > 0);
    const shortMsgBits = [];
    if (!selfFunded && loanGap > 0) shortMsgBits.push(`Loan Gap: ${fmtINR(loanGap)}`);
    if (!selfFunded && emiShortfall > 0) shortMsgBits.push(`EMI Shortfall: ${fmtINR(emiShortfall)}`);
    if (dpShortfall > 0) shortMsgBits.push(`Additional DP to Accumulate: ${fmtINR(dpShortfall)}`);

    if (anyShortfall){
      document.getElementById('modalShortfallWrap').style.display = 'block';
      document.getElementById('modalShortfall').innerHTML =
        `<span style="font-weight:bold; font-size:1.0em; color:#ff2b2b;">${shortMsgBits.join(' | ')}</span>`;
      document.getElementById('modalComparisonRow').classList.add('shortfall-row');
      if (!selfFunded) document.getElementById('cellEMI').classList.toggle('shortfall-cell', emiShortfall>0);
      if (!selfFunded) document.getElementById('cellEligibility').classList.toggle('shortfall-cell', loanGap>0);
    } else {
      document.getElementById('modalShortfallWrap').style.display = 'none';
      document.getElementById('modalComparisonRow').classList.remove('shortfall-row');
      document.getElementById('cellEMI').classList.remove('shortfall-cell');
      document.getElementById('cellEligibility').classList.remove('shortfall-cell');
    }

    let nudges = '';
    if (!selfFunded && loanGap > 0){
      nudges += `<div style="margin-top:6px;">Loan gap exists — consider more down payment or co-applicant income, or reduce target car price.</div>`;
    }
    if (!selfFunded && emiShortfall > 0){
      nudges += `<div style="margin-top:6px;">EMI exceeds affordability — consider increasing tenure or lowering loan amount.</div>`;
    }
    if (!anyShortfall){
      nudges += `<div style="margin-top:6px;">You're in a good shape. Next steps: shortlist banks and prepare documents for pre-approval.</div>`;
    }
    document.getElementById('modalPitch').innerHTML = nudges;

    const nameParam = encodeURIComponent(document.getElementById('fullName').value || '');
    document.getElementById('bookCall').href = `/book-call?name=${nameParam}`;
    document.getElementById('requestReport').href = `/request-report?name=${nameParam}`;

    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    document.getElementById('modalStatus').textContent = 'Saving your inputs...';

    // Best-effort save (non-blocking)
    try {
      const resp = await fetch('/api/saveCarPurchaseForm', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(detailed)
      });
      if (resp.ok) document.getElementById('modalStatus').textContent = 'Saved — advisor will follow up.';
      else document.getElementById('modalStatus').textContent = 'Saved locally but server save failed.';
    } catch (err){
      console.warn('Save failed', err);
      document.getElementById('modalStatus').textContent = 'Could not save to server — try Request Detailed Report.';
    }

  } catch (errCompute) {
    console.error('Compute failed:', errCompute);
    alert('An unexpected error occurred during computation. Open browser console for details.');
  }
});

// modal close handlers (preserved)
document.getElementById('quickModal').addEventListener('click', function(e){
  if (e.target === this){
    this.style.display = 'none';
    this.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
});
document.addEventListener('keydown', function(e){
  if (e.key === 'Escape'){
    const modal = document.getElementById('quickModal');
    if (modal && modal.style.display === 'flex'){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
  }
});
</script>
</body>
</html>
