<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Purchase Planning — Quick Requirement & Down-payment Plan</title>
  <style>
    /* Visual parity with your Health form */
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;padding:28px;margin:0}
    .form-wrap{max-width:980px;margin:0 auto;background:#fff;padding:22px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1{color:#0b4da0;margin:0 0 8px;text-align:center}
    h2{color:#d41031;margin:0 0 4px;text-align:center}
    p.lead{color:#374151;margin:10px 0 16px;text-align:center}
    label{display:block;margin:8px 0 6px;font-weight:700;color:#111}
    label .req{color:#c00;margin-left:6px}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #d1d5db;box-sizing:border-box;font-size:14px}
    input[readonly]{background:#f3f4f6}
    .two-col{display:flex;gap:12px}
    .two-col > div{flex:1}
    .btn{background:#0b5fff;color:#fff;padding:10px 14px;border-radius:6px;border:none;cursor:pointer}
    .btn[disabled]{opacity:.7;cursor:default}
    .small{font-size:13px;color:#374151}
    .hidden{display:none}
    .disabled{background:#f3f4f6;color:#6b7280}
    @media (max-width:720px){ .two-col{flex-direction:column} }
    .why-matters { font-weight: bold; color: #057722; font-size: .8em; margin-top: 4px; }

    /* badge */
    .self-fund-badge { display:none; margin-top:10px; padding:6px 10px; background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; border-radius:8px; font-weight:700; text-align:left; }

    /* Modal styles (same pattern) */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center}
    .modal{background:#fff;padding:22px;border-radius:10px;max-width:820px;width:96%;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .modal h2{margin:0 0 8px;text-align:center}
    .required-large{font-weight:900;font-size:1.2rem;color:#0b5fff;margin-top:6px;text-align:center}
    .shortfall-large{color:#ff2b2b;font-weight:900;font-size:1.1rem;margin-top:6px;text-align:center}
    h3.comparison-title{ text-align:center; font-weight:800; font-size:1.05rem; text-decoration:underline; margin-top:16px; margin-bottom:6px; text-transform:uppercase; }
    .comparison-table{width:100%;border-collapse:collapse;margin-top:6px}
    .comparison-table th,.comparison-table td{border:1px solid #e6eef9;padding:10px;text-align:center}
    .comparison-table tr.shortfall-row{background:#fff4f4}
    .shortfall-cell{color:#ff2b2b;font-weight:800}
    .modalPitch{font-size:1.02rem;color:#333;margin-top:12px;text-align:center;line-height:1.35}
    .urgent-warning{font-weight:800;font-size:1.05rem;color:#e60000;text-align:center;margin-top:10px;margin-bottom:8px}
    .cta-row{display:flex;gap:12px;margin-top:18px;justify-content:flex-end}
    .cta-row a{flex:1;padding:12px 14px;border-radius:8px;text-decoration:none;color:#fff;text-align:center;display:inline-block}
    .primary-cta{background:#007bff}
    .secondary-cta{background:#0b5fff;opacity:.95}
    .status-msg{font-size:13px;margin-top:8px;color:#333}
    .caption-small{font-size:12px;color:#6b7280;margin-top:6px}
    .note-muted{font-size:13px;color:#6b7280;margin-top:6px}
    /* small helper for the income source block */
    .income-row{display:flex;gap:8px;align-items:center}
    .income-row input[type="checkbox"]{width:auto;margin-right:8px}
    .income-amount{width:48%}
    .income-amount input{width:100%}
    .income-breakdown{font-size:13px;color:#374151;margin-top:8px}
  </style>
</head>
<body>
  <div class="form-wrap" role="main" aria-labelledby="title">
    <h1 id="title">Your Home Buying Journey Planner</h1>
    <h2><strong>YOUR DREAM HOME, ONE SMART STEP AT A TIME</strong></h2>
    <p class="lead">
      Share what you’ve got and what you’re aiming for — we’ll crunch the numbers to show your loan needs, EMI fit, and a savings path to unlock your new home.
    </p>

    <form id="homeForm" novalidate>
      <input type="hidden" id="timestamp" name="timestamp" value="">

      <!-- Identity (unchanged) -->
      <label for="fullName">Full Name <span class="req">*</span></label>
      <input id="fullName" name="fullName" type="text" placeholder="e.g., Sangeeta R" required>

      <label for="email">Email <span class="req">*</span></label>
      <input id="email" name="email" type="text" placeholder="you@example.com" required>

      <div class="two-col">
        <div>
          <label for="mobile">Mobile Number <span class="req">*</span></label>
          <input id="mobile" name="mobile" type="text" placeholder="10-digit mobile (6-9 start)" required>
        </div>
        <div>
          <label for="gender">Gender <span class="req">*</span></label>
          <select id="gender" name="gender" required>
            <option value="">Select</option><option value="male">Male</option><option value="female">Female</option>
          </select>
        </div>
      </div>

      <div class="two-col">
        <div>
          <label for="dob">Date of Birth <span class="req">*</span></label>
          <input id="dob" name="dob" type="date" required>
          <div class="caption-small">Minimum age: 23 years (form enforces this).</div>
        </div>
        <div>
          <label for="age">Age <span class="req">*</span></label>
          <input id="age" name="age" type="text" readonly placeholder="Calculated from DOB" required>
        </div>
      </div>

      <div class="two-col">
        <div>
          <label for="city">City of Residence <span class="req">*</span></label>
          <select id="city" name="city" required></select>
          <!-- when 'Others' selected this will show -->
          <input id="otherCityResidence" name="otherCityResidence" type="text" placeholder="Enter your city" style="margin-top:8px;display:none">
        </div>
        <div>
          <!-- cityTier removed as requested - preserve layout -->
          <label style="visibility:hidden">placeholder</label>
          <input style="visibility:hidden">
        </div>
      </div>

      <!-- Property & Finance Details -->
      <div style="margin-top:14px">
        <h3>Property & Finance Details</h3>

        <div class="two-col">
          <div>
            <label for="targetCity">Target Property City <span class="req">*</span></label>
            <select id="targetCity" name="targetCity" required></select>
            <input id="otherCityTarget" name="otherCityTarget" type="text" placeholder="Enter target city" style="margin-top:8px;display:none">
          </div>
          <div>
            <label for="propertyType">Property Type <span class="req">*</span></label>
            <select id="propertyType" name="propertyType" required>
              <option value="">Select</option>
              <option>Apartment</option>
              <option>Independent House</option>
              <option>Plot</option>
              <option>Under-construction</option>
              <option>Resale</option>
            </select>
          </div>
        </div>

        <div class="two-col">
          <div>
            <label for="purchaseYears">Purchase Timeline (Years) <span class="req">*</span></label>
            <select id="purchaseYears" name="purchaseYears" required>
              <option value="">Select years</option>
              <option value="1">1 year</option>
              <option value="2">2 years</option>
              <option value="3">3 years</option>
              <option value="4">4 years</option>
              <option value="5">5 years</option>
              <option value="6">6 years</option>
              <option value="7">7 years</option>
              <option value="8">8 years</option>
              <option value="9">9 years</option>
              <option value="10">10 years</option>
              <option value="11">11 years</option>
              <option value="12">12 years</option>
              <option value="13">13 years</option>
              <option value="14">14 years</option>
              <option value="15">15 years</option>
            </select>
            <div class="caption-small">Select how many years until you plan to purchase.</div>
          </div>
          <div>
            <label for="estimatedCost">Target Property Estimated Cost (₹) <span class="req">*</span></label>
            <input id="estimatedCost" name="estimatedCost" type="text" placeholder="₹ e.g., 1,25,00,000" required>
            <div class="why-matters">This anchors loan amount and EMI.</div>
          </div>
        </div>

        <div class="two-col">
          <div>
            <label for="expectedDownPayment">Expected Down Payment at Purchase (₹) <span class="req">*</span></label>
            <input id="expectedDownPayment" name="expectedDownPayment" type="text" placeholder="₹ e.g., 25,00,000" required>
            <div class="caption-small">Typical banks expect 10–25% as down payment; enter the amount you plan to pay upfront at purchase time.</div>
          </div>
          <div>
            <label for="existingDownSavings">Existing Down Payment Savings (₹)</label>
            <input id="existingDownSavings" name="existingDownSavings" type="text" placeholder="₹ amount you already have saved">
            <div class="caption-small">If you already have savings towards the down payment, enter it here.</div>
          </div>
        </div>

        <div class="two-col" style="margin-top:8px">
          <div>
            <label for="expectedReturn">Expected Rate of Return on Investments (%)</label>
            <input id="expectedReturn" name="expectedReturn" type="number" min="0" max="25" step="0.1" placeholder="e.g., 7.5">
            <div class="caption-small">Used to estimate monthly investment needed to accumulate remaining down payment over selected years.</div>
          </div>
          <div>
            <label for="otherCommitments">Other Monthly Financial Commitments (₹)</label>
            <input id="otherCommitments" name="otherCommitments" type="text" placeholder="Existing EMIs, obligations">
          </div>
        </div>

        <!-- NEW: Income Sources (surgically added earlier) -->
        <div style="margin-top:12px">
          <h3>Income Sources (enter monthly amounts)</h3>

          <div class="two-col" style="align-items:center">
            <div>
              <div class="income-row">
                <input type="checkbox" id="salariedChk" class="incomeChk" data-weight="1">
                <label for="salariedChk" style="margin:0;font-weight:700">Salaried</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="salariedIncome" type="text" placeholder="Monthly salaried income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="businessChk" class="incomeChk" data-weight="0.8">
                <label for="businessChk" style="margin:0;font-weight:700">Business</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="businessIncome" type="text" placeholder="Monthly business income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="two-col" style="align-items:center;margin-top:8px">
            <div>
              <div class="income-row">
                <input type="checkbox" id="selfEmpChk" class="incomeChk" data-weight="0.8">
                <label for="selfEmpChk" style="margin:0;font-weight:700">Self-employed Professional</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="selfEmpIncome" type="text" placeholder="Monthly professional income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="agriChk" class="incomeChk" data-weight="0.5">
                <label for="agriChk" style="margin:0;font-weight:700">Agricultural</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="agriIncome" type="text" placeholder="Monthly agricultural income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="two-col" style="align-items:center;margin-top:8px">
            <div>
              <div class="income-row">
                <input type="checkbox" id="rentalChk" class="incomeChk" data-weight="0.7">
                <label for="rentalChk" style="margin:0;font-weight:700">Rental Income</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="rentalIncome" type="text" placeholder="Monthly rental income (₹)" disabled>
              </div>
            </div>
            <div>
              <div class="income-row">
                <input type="checkbox" id="otherChk" class="incomeChk" data-weight="0.5">
                <label for="otherChk" style="margin:0;font-weight:700">Other</label>
              </div>
              <div class="income-amount" style="margin-top:6px">
                <input id="otherIncome" type="text" placeholder="Other monthly income (₹)" disabled>
              </div>
            </div>
          </div>

          <div class="income-breakdown" style="margin-top:10px">
            <!-- prominent readonly greyd-out input for Weighted Monthly Income -->
            <label for="weightedMonthlyInput" style="margin:0;font-weight:700">Weighted Monthly Income</label>
            <input id="weightedMonthlyInput" type="text" readonly value="₹0" style="background:#f3f4f6;margin-top:6px;font-weight:700">
            <div class="caption-small" style="margin-top:6px">Weights applied: Salaried 100%, Business 80%, Self-employed 80%, Agricultural 50%, Rental 70%, Other 50% (indicative).</div>
          </div>
        </div>
        <!-- END NEW: Income Sources -->

        <div class="two-col" style="margin-top:12px">
          <div>
            <label for="loanTenureYears">Preferred Loan Tenure (Years) <span class="req">*</span></label>
            <input id="loanTenureYears" name="loanTenureYears" type="text" min="1" max="40" placeholder="e.g., 20" required>
          </div>
          <div>
            <label for="interestRate">Expected Home Loan Interest Rate (%) <span class="req">*</span></label>
            <input id="interestRate" name="interestRate" type="text" min="5" max="20" placeholder="e.g., 8.5" required>
          </div>
        </div>

        <!-- badge for self-funded -->
        <div id="selfFundBadge" class="self-fund-badge">Self-funded — loan not required</div>

        <div class="two-col" style="margin-top:12px">
          <div>
            <label for="monthlyAffordability">Monthly EMI Affordability (₹) <span class="req">*</span></label>
            <input id="monthlyAffordability" name="monthlyAffordability" type="text" placeholder="₹ you can comfortably pay" required>
            <div class="caption-small">We’ll use the lesser of this value and the FOIR benchmark (50% of monthly weighted income after commitments) as the affordability used to compute eligibility.</div>
          </div>
          <div>
            <label style="margin-top:2px"> (Using weighted monthly income from sources)</label>
            <input id="placeholderAnnualNote" name="placeholderAnnualNote" type="text" readonly value="Weighted monthly income used for calculations" />
            <div class="why-matters" style="margin-top:6px">Determines eligible EMI & loan amount.</div>
          </div>
        </div>
      </div>

      <!-- Consent -->
      <div style="margin-top:12px">
        <input id="consent" name="consent" type="checkbox" required>
        <label for="consent">I consent to my information being used to generate a personalised home purchase recommendation and to be contacted by the advisor. <span style="color:#c00">*</span></label>
      </div>

      <!-- Buttons -->
      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button class="btn" id="computeBtn" type="button">Compute Quick Recommendation</button>
        <span id="statusMsg" class="small" aria-live="polite"></span>
      </div>

      <textarea id="detailedData" style="display:none" aria-hidden="true"></textarea>
    </form>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="quickModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Quick Recommendation</h2>

      <div id="modalHeadline" class="required-large">—</div>

      <div id="modalShortfallWrap" style="display:none">
        <div class="shortfall-large" id="modalShortfall">—</div>
      </div>

      <h3 class="comparison-title">MINI COMPARISON</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Loan Requirement (₹)</th>
            <th>Loan Eligibility (₹)</th>
            <th>Estimated EMI (₹)</th>
            <th>EMI Affordability (₹)</th>
          </tr>
        </thead>
        <tbody>
          <tr id="modalComparisonRow">
            <td id="cellRequirement">—</td>
            <td id="cellEligibility">—</td>
            <td id="cellEMI">—</td>
            <td id="cellAffordability">—</td>
          </tr>
        </tbody>
      </table>

      <h3 class="comparison-title" style="margin-top:14px">DOWN PAYMENT PLAN</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Expected DP (₹)</th>
            <th>Existing Savings (₹)</th>
            <th>Additional DP to Accumulate (₹)</th>
            <th>Years to Accumulate</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="cellExpectedDP">—</td>
            <td id="cellExistingDP">—</td>
            <td id="cellDPShortfall">—</td>
            <td id="cellYears">—</td>
          </tr>
        </tbody>
      </table>

      <div style="margin-top:10px;text-align:center">
        <div id="cellMonthlySIP" class="required-large">—</div>
        <div class="caption-small" id="cellSIPNotes"> </div>
      </div>

      <!-- NEW: income breakdown area (keeps your modal layout) -->
      <div id="modalIncomeBreakdown" class="caption-small" style="margin-top:12px; text-align:left"></div>

      <div id="modalPitch" class="modalPitch"></div>

      <div class="cta-row" style="margin-top:12px">
        <a id="bookCall" class="primary-cta" href="#" target="_blank">Request a Call</a>
        <a id="requestReport" class="secondary-cta" href="/request-report" target="_blank">Request Detailed Report</a>
      </div>
      <div id="modalStatus" class="status-msg"></div>
    </div>
  </div>

<script>
/* ---------- Utilities (unchanged) ---------- */
function parseNum(v){
  if (v === undefined || v === null) return 0;
  const s = (''+v).replace(/,/g,'').replace(/₹/g,'').replace(/N\/A/g,'').trim();
  if (s === '') return 0;
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtINR(n){
  if (!isFinite(n)) return '—';
  return '₹' + Math.round(n).toLocaleString('en-IN');
}
function attachCurrencyMask(el){
  if (!el) return;
  el.addEventListener('input', function () {
    if (el.disabled) return;
    const raw = el.value || '';
    const digits = raw.replace(/\D/g, '');
    if (digits === '') { el.value = ''; return; }
    const limited = digits.slice(0, 14);
    const formatted = new Intl.NumberFormat('en-IN').format(Number(limited));
    el.value = '₹' + formatted;
  });
  el.addEventListener('blur', function () {
    if (el.disabled) return;
    const digits = (el.value || '').replace(/\D/g, '');
    el.value = digits === '' ? '' : '₹' + new Intl.NumberFormat('en-IN').format(Number(digits));
  });
  el.addEventListener('focus', function () {
    if (el.disabled) return;
    const digits = (el.value || '').replace(/\D/g, '');
    el.value = digits ? digits : '';
  });
}

/* EMI & savings math (unchanged) */
function emi(p, annualRatePct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualRatePct/12)/100;
  if (p <= 0 || n <= 0) return 0;
  if (r <= 0) return p / n;
  const pow = Math.pow(1+r, n);
  return p * r * pow / (pow - 1);
}
function loanFromEmi(emiAmt, annualRatePct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualRatePct/12)/100;
  if (emiAmt <= 0 || n <= 0) return 0;
  if (r <= 0) return emiAmt * n;
  const pow = Math.pow(1+r, n);
  return emiAmt * (pow - 1) / (r * pow);
}
function monthlyInvestmentForFV(fv, annualReturnPct, years){
  const n = Math.max(1, Math.round(years*12));
  const r = (annualReturnPct/12)/100;
  if (fv <= 0) return 0;
  if (r <= 0) return fv / n;
  const pow = Math.pow(1+r, n);
  return fv * r / (pow - 1);
}

/* ---------- DOM wiring + protections ---------- */
document.addEventListener('DOMContentLoaded', function(){
  try {
    document.getElementById('timestamp').value = new Date().toLocaleString();

    // DOB max to enforce min age = 23
    const dobEl = document.getElementById('dob');
    (function setDobMax(){
      const now = new Date();
      const y = now.getFullYear() - 23;
      const m = String(now.getMonth() + 1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      if (dobEl) dobEl.max = `${y}-${m}-${d}`;
    })();

    // DOB -> age calc
    const ageField = document.getElementById('age');
    if (dobEl) {
      dobEl.addEventListener('change', function(){
        const v = this.value;
        if (!v){ ageField.value = ''; return; }
        const d = new Date(v + 'T00:00:00');
        if (isNaN(d)){ ageField.value=''; return; }
        const now = new Date();
        let age = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
        age = Math.max(0, age);
        if (age < 23){
          alert('Minimum age must be 23 years.');
          this.value = '';
          ageField.value = '';
          return;
        }
        ageField.value = age;
      });
    }

    // Cities: top 30 alphabetical + Others last
    const citySelect = document.getElementById('city');
    const targetCitySelect = document.getElementById('targetCity');
    const cities = [
      "Ahmedabad","Amritsar","Bengaluru","Bhopal","Bhubaneswar","Chandigarh","Chennai","Coimbatore",
      "Dehradun","Delhi","Faridabad","Ghaziabad","Gurugram","Guwahati","Hyderabad","Indore","Jaipur",
      "Jalandhar","Kanpur","Kochi","Kolkata","Lucknow","Madurai","Mumbai","Nagpur","Nashik","Patna",
      "Pune","Surat","Vadodara","Vijayawada"
    ];
    // append Others at last
    function fillCity(select){
      if (!select) return;
      select.innerHTML = '<option value="">Select City</option>';
      cities.forEach(c => { const o=document.createElement('option'); o.value=c; o.text=c; select.appendChild(o); });
      const o = document.createElement('option'); o.value='Others'; o.text='Others'; select.appendChild(o);
    }
    fillCity(citySelect);
    fillCity(targetCitySelect);

    // show/hide other city input when 'Others' selected
    const otherCityResidence = document.getElementById('otherCityResidence');
    const otherCityTarget = document.getElementById('otherCityTarget');
    function handleCityChange(e){
      const isResidence = e.target.id === 'city';
      if (isResidence){
        if (e.target.value === 'Others') otherCityResidence.style.display = 'block'; else otherCityResidence.style.display = 'none';
      } else {
        if (e.target.value === 'Others') otherCityTarget.style.display = 'block'; else otherCityTarget.style.display = 'none';
      }
    }
    if (citySelect) citySelect.addEventListener('change', handleCityChange);
    if (targetCitySelect) targetCitySelect.addEventListener('change', handleCityChange);

    // Currency masks: include new income inputs
    [
      'estimatedCost','expectedDownPayment','existingDownSavings','loanRequirement','otherCommitments',
      'monthlyAffordability','salariedIncome','businessIncome','selfEmpIncome','agriIncome','rentalIncome','otherIncome'
    ].forEach(id => { const el=document.getElementById(id); if (el) attachCurrencyMask(el); });

    // Update loan requirement whenever estimatedCost or expectedDownPayment changes
    const costEl = document.getElementById('estimatedCost');
    const expectedDP = document.getElementById('expectedDownPayment');
    const existingDP = document.getElementById('existingDownSavings');
    const loanReqEl = document.getElementById('loanRequirement');
    const selfFundBadge = document.getElementById('selfFundBadge');

    function setLoanFieldsNA(flag){
      const loanTen = document.getElementById('loanTenureYears');
      const intRate = document.getElementById('interestRate');
      const monthlyAff = document.getElementById('monthlyAffordability');
      const otherCommit = document.getElementById('otherCommitments');

      if (flag){
        [loanTen,intRate,monthlyAff,otherCommit].forEach(el=>{
          if (!el) return;
          el.dataset.prevValue = el.value || '';
          el.dataset.prevRequired = el.hasAttribute('required') ? 'true' : 'false';
          el.value = 'N/A';
          el.disabled = true;
          el.classList.add('disabled');
          el.setAttribute('aria-disabled','true');
          el.required = false;
          el.readOnly = true;
        });
        if (loanReqEl) loanReqEl.value = '₹0';
        if (selfFundBadge) selfFundBadge.style.display = 'block';
      } else {
        [loanTen,intRate,monthlyAff,otherCommit].forEach(el=>{
          if (!el) return;
          el.disabled = false;
          el.classList.remove('disabled');
          el.removeAttribute('aria-disabled');
          el.readOnly = false;
          if (typeof el.dataset.prevValue !== 'undefined'){
            el.value = el.dataset.prevValue;
            delete el.dataset.prevValue;
          } else {
            el.value = '';
          }
          if (el.dataset.prevRequired === 'true') el.setAttribute('required','required');
          delete el.dataset.prevRequired;
        });
        if (loanReqEl) { /* will be recalculated */ }
        if (selfFundBadge) selfFundBadge.style.display = 'none';
      }
    }

    function updateLoanRequirement(){
      const cost = parseNum(costEl.value);
      const expDP = parseNum(expectedDP.value);
      if (!cost || !expDP){
        if (loanReqEl) loanReqEl.value = '';
        setLoanFieldsNA(false);
        return;
      }
      if (expDP === cost){
        setLoanFieldsNA(true);
        return;
      } else {
        setLoanFieldsNA(false);
        const req = Math.max(0, cost - Math.max(0, expDP));
        loanReqEl.value = req ? '₹' + new Intl.NumberFormat('en-IN').format(req) : '';
      }
    }
    if (costEl) costEl.addEventListener('input', updateLoanRequirement);
    if (expectedDP) expectedDP.addEventListener('input', updateLoanRequirement);
    if (existingDP) existingDP.addEventListener('input', function(){ /* noop */ });

    // Income sources wiring
    const incomeCheckboxes = document.querySelectorAll('.incomeChk');
    incomeCheckboxes.forEach(chk => {
      chk.addEventListener('change', function(){
        const id = this.id.replace('Chk','Income');
        const input = document.getElementById(id);
        if (!input) return;
        input.disabled = !this.checked;
        if (!this.checked) input.value = '';
        updateWeightedMonthly();
      });
    });
    ['salariedIncome','businessIncome','selfEmpIncome','agriIncome','rentalIncome','otherIncome'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateWeightedMonthly);
    });

    function updateWeightedMonthly(){
      const mapping = [
        {chk:'salariedChk', id:'salariedIncome', w:1},
        {chk:'businessChk', id:'businessIncome', w:0.8},
        {chk:'selfEmpChk', id:'selfEmpIncome', w:0.8},
        {chk:'agriChk', id:'agriIncome', w:0.5},
        {chk:'rentalChk', id:'rentalIncome', w:0.7},
        {chk:'otherChk', id:'otherIncome', w:0.5}
      ];
      let total = 0;
      mapping.forEach(m => {
        const chk = document.getElementById(m.chk);
        const el = document.getElementById(m.id);
        const val = el ? parseNum(el.value) : 0;
        if (chk && chk.checked && val>0) total += val * m.w;
      });
      const weightedInput = document.getElementById('weightedMonthlyInput');
      if (weightedInput){
        weightedInput.value = total ? fmtINR(total) : '₹0';
      }
    }

    // Ensure initial state run
    setTimeout(updateLoanRequirement, 120);

  } catch (e) {
    console.warn('Initialization warning (non-fatal):', e);
  }
});

/* ---------- Compute & Modal (updated: FOIR -> 50%, Affordability uses MIN vs bench, Eligibility = 5x annual weighted income) ---------- */
document.getElementById('computeBtn').addEventListener('click', async function(){
  try {
    const consent = document.getElementById('consent');
    if (!consent || !consent.checked){ alert('Please provide consent to proceed.'); consent && consent.focus(); return; }

    const email = (document.getElementById('email').value || '').trim();
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('Enter a valid email'); return; }
    const mobile = (document.getElementById('mobile').value || '').trim();
    if (!/^[6-9]\d{9}$/.test(mobile)){ alert('Enter valid 10-digit mobile starting with 6-9'); return; }

    let age = parseInt(document.getElementById('age').value || '0', 10);
    if (!age || age < 23){ alert('You must be at least 23 years old to proceed.'); return; }

    // compute total weighted monthly income from sources
    const mapping = [
      {chk:'salariedChk', id:'salariedIncome', w:1, label:'Salaried'},
      {chk:'businessChk', id:'businessIncome', w:0.8, label:'Business'},
      {chk:'selfEmpChk', id:'selfEmpIncome', w:0.8, label:'Self-employed'},
      {chk:'agriChk', id:'agriIncome', w:0.5, label:'Agricultural'},
      {chk:'rentalChk', id:'rentalIncome', w:0.7, label:'Rental'},
      {chk:'otherChk', id:'otherIncome', w:0.5, label:'Other'}
    ];
    let totalWeightedMonthly = 0;
    const breakdownItems = [];
    mapping.forEach(m => {
      const chk = document.getElementById(m.chk);
      const val = parseNum(document.getElementById(m.id).value);
      if (chk && chk.checked){
        const weighted = Math.round(val * m.w);
        totalWeightedMonthly += weighted;
        breakdownItems.push({label:m.label, raw:val, weight:m.w, weighted:weighted});
      }
    });

    if (totalWeightedMonthly <= 0){
      alert('Please enter at least one income source amount (monthly).');
      return;
    }

    const annualWeightedIncome = totalWeightedMonthly * 12;
    if (isNaN(annualWeightedIncome) || annualWeightedIncome < 200000){ alert('Total weighted annual income must be at least ₹200,000'); return; }

    // City values — if 'Others' selected, prefer the typed field
    function cityValue(selectId, otherId){
      const sel = document.getElementById(selectId);
      if (!sel) return '';
      if (sel.value === 'Others'){
        const other = document.getElementById(otherId);
        return (other && other.value) ? other.value.trim() : 'Others';
      }
      return sel.value;
    }

    const residenceCity = cityValue('city','otherCityResidence');
    const targetCity = cityValue('targetCity','otherCityTarget');

    const cost = parseNum(document.getElementById('estimatedCost').value);
    const expectedDP = parseNum(document.getElementById('expectedDownPayment').value);
    if (cost <= 0){ alert('Please enter a valid Target Property Estimated Cost.'); return; }
    if (expectedDP < 0){ alert('Please enter the Expected Down Payment at purchase.'); return; }
    if (expectedDP > cost){ alert('Expected Down Payment cannot exceed Property Cost.'); return; }

    const existingSavings = parseNum(document.getElementById('existingDownSavings').value);
    if (existingSavings < 0){ alert('Existing Down Payment Savings cannot be negative.'); return; }
    if (existingSavings > expectedDP){ alert('Existing Down Payment Savings cannot exceed Expected Down Payment.'); return; }

    const purchaseYears = parseInt(document.getElementById('purchaseYears').value || '0', 10);
    if (!purchaseYears || purchaseYears < 1 || purchaseYears > 15){ alert('Select Purchase Timeline between 1 and 15 years.'); return; }

    const expectedReturn = parseFloat(document.getElementById('expectedReturn').value || '0');
    if (!isFinite(expectedReturn) || expectedReturn < 0 || expectedReturn > 25){ alert('Expected rate of return must be between 0% and 25%.'); return; }

    // Determine self-funded case
    const selfFunded = (expectedDP === cost && cost > 0);

    // Loan related
    const loanReq = selfFunded ? 0 : Math.max(0, cost - expectedDP);
    const otherCommit = parseNum(document.getElementById('otherCommitments').value);
    const declaredAfford = parseNum(document.getElementById('monthlyAffordability').value);

    let estEmi = 0, eligibleLoanFromAfford = 0, eligibleLoanFromMultiplier = 0, finalEligibility = 0, effectiveAfford = 0, emiShortfall = 0, loanGap = 0;
    let appliedTenure = parseFloat(document.getElementById('loanTenureYears').value || '0');
    const rate = parseFloat(document.getElementById('interestRate').value || '0');

    if (!selfFunded) {
      if (!isFinite(appliedTenure) || appliedTenure < 1 || appliedTenure > 40){ alert('Loan tenure must be between 1 and 40 years.'); return; }
      if (!isFinite(rate) || rate < 5 || rate > 20){ alert('Interest rate must be between 5% and 20%.'); return; }

      const monthlyIncome = totalWeightedMonthly;

      // FOIR set to 50%
      const FOIR = 0.50;
      const benchAfford = Math.max(0, (monthlyIncome * FOIR) - otherCommit);

      const ageVal = parseInt(document.getElementById('age').value || '0', 10);
      const retirementAge = 60;
      let maxAllowedTenure = retirementAge - (ageVal + purchaseYears);
      if (maxAllowedTenure <= 0){
        alert(`Based on your age (${ageVal}) and chosen purchase timeline (${purchaseYears} yrs), you would be at or past retirement age at purchase. Banks typically will not approve a loan in this situation.`);
        return;
      }
      maxAllowedTenure = Math.floor(maxAllowedTenure);
      if (maxAllowedTenure < 1) maxAllowedTenure = 1;
      appliedTenure = Math.min(appliedTenure, maxAllowedTenure);

      if (appliedTenure !== parseFloat(document.getElementById('loanTenureYears').value || '0')){
        const accept = confirm(`You requested a loan tenure of ${document.getElementById('loanTenureYears').value} years, but max allowed at purchase is ${maxAllowedTenure} years.\nPress OK to accept ${maxAllowedTenure} yrs, or Cancel to revise.`);
        if (!accept){
          document.getElementById('loanTenureYears').focus();
          return;
        } else {
          document.getElementById('loanTenureYears').value = appliedTenure;
          document.getElementById('statusMsg').textContent = `Requested tenure reduced to ${appliedTenure} yrs (based on age at purchase).`;
        }
      } else {
        document.getElementById('statusMsg').textContent = '';
      }

      estEmi = Math.round(emi(loanReq, rate, appliedTenure));

      // Affordability used = MIN(client-declared, benchAfford) if client provided one; otherwise benchAfford
      if (declaredAfford > 0){
        effectiveAfford = Math.min(declaredAfford, benchAfford);
      } else {
        effectiveAfford = benchAfford;
      }
      effectiveAfford = Math.round(effectiveAfford);

      // Eligible loan from affordability (reverse EMI)
      eligibleLoanFromAfford = Math.round(loanFromEmi(effectiveAfford, rate, appliedTenure));
      // Eligible loan from multiplier: EXACTLY 5 x annual weighted income (user requirement)
      eligibleLoanFromMultiplier = Math.round(annualWeightedIncome * 5);

      // <-- IMPORTANT CHANGE: final eligibility is EXACTLY the multiplier (5x annual weighted income),
      // per your instruction. We DO NOT take min() with affordability.
      finalEligibility = eligibleLoanFromMultiplier;

      emiShortfall = Math.max(0, estEmi - effectiveAfford);
      loanGap = Math.max(0, loanReq - finalEligibility);
    } else {
      estEmi = null;
      eligibleLoanFromAfford = null;
      eligibleLoanFromMultiplier = null;
      finalEligibility = null;
      effectiveAfford = null;
      emiShortfall = null;
      loanGap = null;
    }

    const dpShortfall = Math.max(0, expectedDP - existingSavings);
    let monthlySIP = 0;
    if (dpShortfall > 0){
      monthlySIP = Math.ceil(monthlyInvestmentForFV(dpShortfall, expectedReturn, purchaseYears));
    } else {
      monthlySIP = 0;
    }

    const detailed = {
      timestamp: document.getElementById('timestamp').value,
      identity: {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        mobile: (document.getElementById('mobile').value || '').trim(),
        gender: document.getElementById('gender').value,
        dob: document.getElementById('dob').value,
        age: parseInt(document.getElementById('age').value || '0',10),
        residenceCity: residenceCity
      },
      property: {
        targetCity: targetCity,
        propertyType: document.getElementById('propertyType').value || '',
        purchaseYears: purchaseYears
      },
      numbers: {
        estimatedCost: cost,
        expectedDownPayment: expectedDP,
        existingDownSavings: existingSavings,
        additionalDPToAccumulate: dpShortfall,
        expectedReturnPct: expectedReturn,
        loanRequirement: loanReq,
        tenureYearsRequested: parseFloat(document.getElementById('loanTenureYears').value || '0'),
        tenureYearsApplied: appliedTenure,
        interestRatePct: rate,
        monthlyAffordDeclared: declaredAfford,
        monthlyAffordBenchmark: Math.round(effectiveAfford || 0),
        otherCommitments: otherCommit,
        annualWeightedIncome: annualWeightedIncome,
        monthlyWeightedIncome: totalWeightedMonthly,
        selfFunded: selfFunded
      },
      incomeBreakdown: breakdownItems,
      computations: {
        estimatedEMI: estEmi,
        eligibleLoanAfford: eligibleLoanFromAfford,
        eligibleLoanMultiplier: eligibleLoanFromMultiplier,
        eligibleLoanFinal: finalEligibility,
        effectiveAfford: effectiveAfford === null ? null : Math.round(effectiveAfford),
        emiShortfall: emiShortfall,
        loanGap: loanGap,
        monthlySIPForDP: monthlySIP
      }
    };
    document.getElementById('detailedData').value = JSON.stringify(detailed);

    // Modal population
    const modal = document.getElementById('quickModal');
    const headline = ( (!selfFunded && loanGap <= 0 && emiShortfall <= 0 && dpShortfall <= 0) || (selfFunded && dpShortfall <= 0) )
      ? `All set — loan (if any), EMI and down payment covered. Nice work!`
      : `Plan summary & advisor suggestions.`;
    document.getElementById('modalHeadline').textContent = headline;

    document.getElementById('cellRequirement').textContent = selfFunded ? 'N/A' : fmtINR(loanReq);
    document.getElementById('cellEligibility').textContent = selfFunded ? 'N/A' : fmtINR(finalEligibility);
    document.getElementById('cellEMI').textContent = selfFunded ? 'N/A' : fmtINR(estEmi);
    document.getElementById('cellAffordability').textContent = selfFunded ? 'N/A' : fmtINR(Math.round(effectiveAfford || 0));

    // DP table
    document.getElementById('cellExpectedDP').textContent = fmtINR(expectedDP);
    document.getElementById('cellExistingDP').textContent = fmtINR(existingSavings);
    document.getElementById('cellDPShortfall').textContent = fmtINR(dpShortfall);
    document.getElementById('cellYears').textContent = purchaseYears + ' yr' + (purchaseYears>1 ? 's' : '');

    // Monthly SIP display
    if (dpShortfall <= 0){
      document.getElementById('cellMonthlySIP').textContent = 'No monthly investment needed';
      document.getElementById('cellSIPNotes').textContent = `Period: ${purchaseYears} year(s) | Expected return: ${expectedReturn}% p.a.`;
    } else {
      document.getElementById('cellMonthlySIP').textContent = fmtINR(monthlySIP) + ' / month';
      document.getElementById('cellSIPNotes').textContent = `Period: ${purchaseYears} year(s) | Expected return: ${expectedReturn}% p.a.`;
    }

    // Income breakdown HTML
    const breakdownHtml = breakdownItems.length ? (
      '<strong>Income (monthly) — weighted breakdown:</strong><ul style="text-align:left;margin-left:18px;margin-top:6px;">' +
      breakdownItems.map(it => `<li>${it.label}: ${fmtINR(it.raw)} × ${Math.round(it.weight*100)}% = ${fmtINR(it.weighted)}</li>`).join('') +
      `</ul><div style="margin-top:6px;"><strong>Total Weighted Monthly Income:</strong> ${fmtINR(totalWeightedMonthly)} (${fmtINR(annualWeightedIncome)}/yr)</div>`
    ) : '<div class="caption-small">No income breakdown provided.</div>';
    document.getElementById('modalIncomeBreakdown').innerHTML = breakdownHtml;

    // Shortfall visuals
    const anyShortfall = (!selfFunded && ((loanGap > 0) || (emiShortfall > 0))) || (dpShortfall > 0);
    const shortMsgBits = [];
    if (!selfFunded && loanGap > 0) shortMsgBits.push(`Loan Gap: ${fmtINR(loanGap)}`);
    if (!selfFunded && emiShortfall > 0) shortMsgBits.push(`EMI Shortfall: ${fmtINR(emiShortfall)}`);
    if (dpShortfall > 0) shortMsgBits.push(`Additional DP to Accumulate: ${fmtINR(dpShortfall)}`);

    if (anyShortfall){
      document.getElementById('modalShortfallWrap').style.display = 'block';
      document.getElementById('modalShortfall').innerHTML =
        `<span style="font-weight:bold; font-size:1.0em; color:#ff2b2b;">${shortMsgBits.join(' | ')}</span>`;
      document.getElementById('modalComparisonRow').classList.add('shortfall-row');
      if (!selfFunded) document.getElementById('cellEMI').classList.toggle('shortfall-cell', emiShortfall>0);
      if (!selfFunded) document.getElementById('cellEligibility').classList.toggle('shortfall-cell', loanGap>0);
    } else {
      document.getElementById('modalShortfallWrap').style.display = 'none';
      document.getElementById('modalComparisonRow').classList.remove('shortfall-row');
      document.getElementById('cellEMI').classList.remove('shortfall-cell');
      document.getElementById('cellEligibility').classList.remove('shortfall-cell');
    }

    // Nudges
    let nudges = '';
    if (!selfFunded && loanGap > 0){
      nudges += `<div style="margin-top:6px;">Loan gap exists — consider additional co-applicant income, increase down payment, or reduce target property cost.</div>`;
    }
    if (!selfFunded && emiShortfall > 0){
      nudges += `<div style="margin-top:6px;">EMI exceeds affordability — consider tenure adjustment or altering loan/target parameters.</div>`;
    }
    if (!anyShortfall){
      nudges += `<div style="margin-top:6px;">You're in good shape. Next steps: shortlist banks and prepare documents for pre-approval.</div>`;
    }
    document.getElementById('modalPitch').innerHTML = nudges;

    const nameParam = encodeURIComponent(document.getElementById('fullName').value || '');
    document.getElementById('bookCall').href = `/book-call?name=${nameParam}`;
    document.getElementById('requestReport').href = `/request-report?name=${nameParam}`;

    // Show modal
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    document.getElementById('modalStatus').textContent = 'Saving your inputs...';

    // Best-effort save (non-blocking)
    try {
      const resp = await fetch('/api/saveHomePurchaseForm', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(detailed)
      });
      if (resp.ok) document.getElementById('modalStatus').textContent = 'Saved — advisor will follow up.';
      else document.getElementById('modalStatus').textContent = 'Saved locally but server save failed.';
    } catch (err){
      console.warn('Save failed', err);
      document.getElementById('modalStatus').textContent = 'Could not save to server — try Request Detailed Report.';
    }

  } catch (errCompute) {
    console.error('Compute failed:', errCompute);
    alert('An unexpected error occurred during computation. Open browser console for details.');
  }
});

// modal close handlers
document.getElementById('quickModal').addEventListener('click', function(e){
  if (e.target === this){
    this.style.display = 'none';
    this.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
});
document.addEventListener('keydown', function(e){
  if (e.key === 'Escape'){
    const modal = document.getElementById('quickModal');
    if (modal && modal.style.display === 'flex'){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
  }
});
</script>
</body>
</html>
